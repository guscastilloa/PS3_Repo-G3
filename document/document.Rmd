---
title: 'Problem Set 3: Making Money with ML?'
author:
- Gustavo Adolfo Castillo Álvarez (201812166),
- Alexander Almeida Ramírez (202225165),
- Jorge Luis Congacha Yunda (201920042) y
- Jaime Orlando Buitrago González (200612390)
date: "`r Sys.Date()`"
output:
  bookdown::pdf_document2:
    number_sections: true
    toc: false
    fig_width: 3
    fig_height: 2
    fig_caption: true
    
    
fontsize: 11pt
geometry: margin=1in
documentclass: article
papersize: letter
lang: es
colorlinks: true
header-includes:
  - \usepackage[utf8]{inputenc}
  - \usepackage{hyperref}
  - \hypersetup{urlcolor = blue, citecolor = blue,linkcolor=blue}
  - \usepackage{floatrow}
  - \floatsetup[figure]{capposition=top}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{dcolumn}
  - \usepackage{float}

subtitle: Big Data y Machine Learning para Economía Aplicada
bibliography: References.bib
nocite: '@*'
csl: apa.csl

---

```{r setup, include=FALSE, echo=FALSE}
require(here)
knitr::opts_chunk$set(echo = TRUE, fig.pos = 'H', warning = FALSE, message = FALSE)

fix_textable_ref <- function(refname, tex_table){
  s <- paste0(fixed("\\caption\\{(\\\\#tab:"), refname, ")")
  o <- gsub("\\caption\\{", s,tex_table)
  o
  }

#source("../scripts/00_packages.R", local = knitr::knit_global())
#library(ggplot2)
here::set_here(path = "../")
source(here("scripts","00_packages.R"), local = knitr::knit_global())
```
```{r input_data, include=FALSE, echo=FALSE}
#sf_db <- st_read(here("stores/raw/spatial_data/sf_db.gpkg"))
#loca <- st_read(here("stores/raw/spatial_data/GPKG_MR_V1223.gpkg"), layer = 'Loca')
```

# Introducción

En su \textit{paper}, @rosen proporciona una aproximación metodológica (econométrica) para estimar precios hedónicos. Más específicamente, explora los equilibrios del mercado y las decisiones de los agentes y los efectos en el bienestar para evidenciar la relación entre los precios de los bienes y sus diferentes características. Esta fue una contribución importante para estimar los precios (Hedónicos) de los bienes a partir de las características o atributos (precios implícitos) a partir de la observación de los precios de bienes heterogéneos sus características asociadas.

Como uno de los \textit{papers} más citados del \textit{Journal of Political Economy} [@greenstone], se obtiene una aproximación al comportamiento de la oferta y demanda (equilibro) a partir del proceso generador de datos entre los bienes y sus características. Para el mercado inmobiliario -en el que los comportamientos de los agentes, oferta y demanda, y equilibrios no se pueden explicar en su totalidad con la teoría microeconómica convencional-, esta aproximación ha sido de singular importancia, más aún en el contexto de la ciudad de Bogotá.

Así por ejemplo, @perdomo utiliza los precios hedónicos cómo método econométrico para estimar el precio de las viviendas y posteriormente el de la cercanía a Transmileno; @carriazo identifican cómo de no incluir la calidad del aire en las estimación a través de precio hedónicos conlleva un sesgo en los precios de las viviendas en Bogotá. @lozano utilizan variables espaciales en los submercados de la viviendas para estimar los precios en Bogotá, identificando una gran capacidad predictiva, pero afectada (sobre estimación) por los estratos socioeconómicos. También se encuentran @medina quienes demuestran como los subsidios aplicados a las tarifas de los servicios públicos se transfieren al precio de las viviendas.

Esta breve exploración bibliográfica refleja los usos y potencialidades de la contribución de @rosen al mercado inmobiliario con énfasis en la ciudad de Bogotá. Claro está, como la capital de Colombia, Bogotá es una ciudad heterogénea con dinámicas poblacionales, sociales y económicas distribuidas a por todo el territorio urbano, las cuales pueden afectar los precios del mercado inmobiliario. Más aun, en una localidad como Chapinero, la cual es una de las áreas centrales de la ciudad; con una gran catnidad de población flotante; donde se cuenta con vías que se conectan con el sistema de movilidad de la ciudad; se tienen usos del suelo asociados a actividades comerciales y residenciales; y se tienen parques, canales y corredores ecológicos (Decreto 468, 2006).

Por estas características, tal vez Chapinero sea la localidad con la mayor complejidad de formas de habitar el territorio de la ciudad del país, lo cual la hace un espacio geográfico donde convergen múltiples factores que afectan los precios de las viviendas. Por tal razón, construir uno o varios modelos predictivos de los precios es desafiante y una necesidad, ante una potencial inversión que compre la mayor cantidad de predios, gastando lo menos posible.

Ahora bien, para construir el o los modelos se utilizó una muestra de los anuncios publicados en la página web \href{ https://www.properati.com.co/}{Properati}. Este sitio web de origen argentino y con presencia en varios países de Latinoamérica, le permite a propietarios publicar un bien inmueble con la mayor cantidad de información (precio, características y amenidades, ubicación y descripción), y a personas interesadas en adquirir o arrendar un bien contactarse con el comprador. Es decir, se utilizó una página web que ofrece servicios de intermediación, pero que permite caracterizar la oferta de bienes en Bogotá.

De igual manera, se utilizó la información de Open Street Map (transporte público, comercio, equipamentos colectivos, y vías y trasnporte público), la cual permitió asociar información geográfica relevante a la muestra de \href{ https://www.properati.com.co/}{Properati}. Así como se utilizó también la información de la página web Infraestructura de Datos Espaciales de Bogotá (Ideca), un portal de libre acceso y consulta de la Unidad Administrativa Especial de Catastro Distrital (UAECD), de donde se utilizaron las bases de datos (capas) de las localidades de Bogotá

Con estas fuentes de información se construyeron diferentes modelos para predecir el precio de las viviendas en Chapinero. Estos modelos aplican los conceptos abordados en la clase \textit{Big Data y Machine Learning para Economía Aplicada}, los cuales se describen con mayor detalle en las siguientes secciones. En las siguientes secciones adicionalmente se encuentran: la presentación de las bases de datos utilizadas, presentando a su vez estadísticas descriptivas que facilitan su comprensión; los resultados obtenidos luego de su impelmentación; y unas conclusiones de todo el ejercicio.

Resultados...

# Datos y Métodos

Los datos principales consistieron en los archivos descargados de la página de datos de la [Competencia en Kaggle](https://www.kaggle.com/competitions/uniandes-bdml-202410-ps3). Esta base de datos contiene 48.930 observaciones, distribuidas en 10.286 observaciones para prueba (21\%) y 38.644 para entrenamiento (79\%). Cada observación representa un inmueble para venta publicado en \href{ https://www.properati.com.co/}{Properati} entre 2019 y 2021 en la ciudad de Bogotá. Dentro de las características de cada inmueble se tienen las áreas (construida y cubierta), el número de habitaciones y baños, el tipo de propiedad (casa o apartamento), y el título y descripciónn con el que se hizo la publicación en la página web y localización (latitud y longitud). Dada la estructura de la base de datos es muy probable que se haya construido a través de un ejercicio de \textit{Web Scrapping} y luego se haya dispuesto para su descarga y uso en el Problem Set 3.

A partir de las descripciones, se utilizó el análisis de texto para constrastar el tipo de inmueble publicado con el que se encuentra en la descripción, extraer el número de pisos de las casas, e identificar el piso en el que se encuentran los apartamentos. Como se tienen todos los inmuebles para Bogotá, en función de su localización (latitud y longitud), se extrajeron aquellas casas y apartamentos dentro de la localidad de Chapinero. Este ejercio se realizó mediante la extracción los de puntos (capa construida con la latitud y longitud) dentro del polígono de Cahpinero (capa del Ideca). Al cruzar la capa de los polígonos las localidades con la tabla de *test* observamos que 593 propiedades se encuentran fuera de Chapinero (Figura \@ref(fig:train-chapi-dots)), que es la localidad en la cuál se predecirán los precios de las viviendas. 

```{r train-chapi-dots, echo=FALSE, message=FALSE, out.width="70%" , message=FALSE, fig.cap="Ubicación datos de validación", dpi=300}
knitr::include_graphics(here('views/figures/train_dots.pdf'))
```

Utilizando el mismo método de análisis espacial, se utilizaron las capas de Open Street Maps para medir las distancias del inmueble a gimnasios, estaciones de Transmilenio, bares, supermercados, colegios, hospitales, principales avenidas, centros comerciales y universidades.Las principales estasdísticas descriptivas según los tipos de bienes inmuebles se ven a continuación:


```{r descriptive-tbl, echo=FALSE, results='asis', message=FALSE, out.width="60%", fig.pos='H'}
library(kableExtra)
stats <- arrow::read_parquet("../stores/db3.parquet")

var <- c("price","surface_covered","surface_total","rooms", "bathrooms",
         "bedrooms","n_pisos_num","piso_numerico",
         "distancia_parque","distancia_transmi",
         "distancia_bar","distancia_colegio",
         "distancia_avenida_principal","distancia_universidad",
         "distancia_gimnasio","distancia_cai","distancia_SM",
         "distancia_hospitales","distancia_comercial")

stats <- data.frame(stats%>%
                      filter(is_chapinero=="Chapinero")%>%
                      select(var, "is_train","operation_type","property_type")
)

stats$price <- stats$price/1000000

summary_list <- list()

for (variable in var) {
  stats[[variable]] <- as.numeric(stats[[variable]])
  summary_data <- stats %>%
    summarise(mean = mean(!!sym(variable), na.rm = TRUE),
              sd = sd(!!sym(variable), na.rm = TRUE),
              min = min(!!sym(variable), na.rm = TRUE),
              max = max(!!sym(variable), na.rm = TRUE))
  summary_list[[variable]] <- summary_data
}

summary_list <- bind_rows(summary_list, .id = "variable")

summary_list$variable <- factor(summary_list$variable,
                                levels=var,
                                labels=c("Precio (millones)",
                                         "Área cubierta ($km^2$)",
                                         "Área total ($km^2$)",
                                         "Habitaciones","Baños",
                                         "Dromitorios","Número de pisos", "Piso",
                                         "Dist. parque ($km$)", 
                                         "Dist. Transmilenio ($km$)",
                                         "Dist. bar ($km$)",
                                         "Dist. colegio ($km$)",
                                         "Dist. avenida ($km$)",
                                         "Dist. universidad ($km$)",
                                         "Dist. gimnasio ($km$)",
                                         "Dist. CAI($km$)",
                                         "Dist. supermercados ($km$)",
                                         "Dist. hospitales ($km$)",
                                         "Dist. centro comercial ($km$)")
)
colnames(summary_list) <- c("Variable", "Promedio", "Desv. est.",
                            "Mín", "Máx.")
knitr::kable(summary_list, align = "lcccc", digits=1, "latex", 
             caption = "Estadísticas descriptivas")%>%
      kable_styling(latex_options = "hold_position")
```

Para la localidad de Chapinero, luego del procedimiento anterior, se obtuvo una base de datos con 10.000 observaciones. En total, se obtuvieron 9.702 (97\%) apartmentos y 298 (3\%) casas en venta. En promedio, los inmuebles fueron publicados a un precio de 847,1 millones, tienen 137,4$mt^2$ de área construida, 128,3$mt^2$ de área habitables, 2,4 habitaciones, 2,6 baños y 2,3 dormitorios. Las amenidades más cercanas son los parques a una distancia promedio de 159,9 metros, centros comerciales a de 246,9 metros y las avenidas a 230,2 metros. Las más lejanas son los bares a 1,1 km, seguido por los hospitales (830 m) y las estaciones de transmileno (801 m).

Sobre este último hallazgo, esta oferta de bienes inmuebles puede estar caracterizada por casas o apartamentos más alejadas de las zonas con mayor flujo de población flotante. Al ser una localidad en la que en su centralidad alberga la mayor oferta de universidades de Bogotá, así como donde se desarrollan actividades comerciales, los inmuebles destinados a usos residenciales que se ofrecen en el mercado se encuentran más alejados de esta centralidad. Claro está, se tiene una heterogénea composición, pues como se observa en la tabla anterior aproximadante las desviaciones estándar de las distancias son la mitad de los valores promedio, y se obtienen distancia en un rango de entre 0 m 3 km.  


# Modelo y resultados

En esta sección se exponen los modelos que se utilizaron para predecir los precios de la vivienda en la localidad de Chapinero, las variables utilizadas en los modelos y la selección de hiperparámetros. En particular, se utilizaron los modelos de bosques, bosques aleatorios, regresión lineal, elasticnet y boosting para realizar la predicción. Finalmente, se presenta una comparación del rendimiento de estos modelos. El mejor resultado se obtuvo con el modelo de Random Forest utilizando como métrica el Mean Absolute Error metric (MAE).  

## Modelo y descripción de las variables
Para todos los modelos utilizados para la predicción, se utilizó el siguiente modelo: 

$$
Precio= f(\text{características propias}, \text{características del vecindario},\text{variables temporales})
$$
<<<<<<< Updated upstream

Siguiendo a @mendieta, se utilizaron tres categorías de variables que capturan atributos que explican el precio de la vivienda. El primero, corresponde a variables que capturan características convencionales d elas viviendas como el número de habitaciones, el número de baños, la superficie total y el tipo de propiedad. El segundo grupo está conformado por características del vecindario que corresponde a criterios de seguridad, por ejemplo, la distancia de la vivienda al Comando de Atención Inmediata(CAI), a criterios de servicios, como la distancia a parques, centros comeciales, instituciones educativas, y de accesibilidad de transporte, por ejemplo, distancia a la estación del transmilenio. Las variables de distancia fueron calculadas utilizando la paqueteria Osmadata del programa R. A continuación, se presenta una tabla con la descripción de las variables: 

Siguiendo a @mendieta, se utilizaron tres categorías de variables que capturan atributos que explican el precio de la vivienda. El primero, corresponde a variables que capturan características convencionales d elas viviendas como el número de habitaciones, el número de baños, la superficie total y el tipo de propiedad. El segundo grupo está conformado por características del vecindario que corresponde a criterios de seguridad, por ejemplo, la distancia de la vivienda al Comando de Atención Inmediata(CAI), a criterios de servicios, como la distancia a parques, centros comeciales, instituciones educativas, y de accesibilidad de transporte, por ejemplo, distancia a la estación del transmilenio. Las variables de distancia fueron calculadas utilizando la paqueteria Osmadata del programa R. El tercero, corresponde a factores de geolocalización,como la longitud y la latitud) y temporales, como el mes y el año, debido a que los precios pueden variar por el ciclo económico. A continuación, se presenta una tabla con la descripción de las variables: 


```{r performance, results='asis', echo=FALSE}
cat("
\\begin{table}[ht]
\\centering
\\caption{Nombres de las variables y su descripción}
\\begin{tabular}{|c|c|}
\\hline
Nombre de la variable & Descripción  \\\\
\\hline
\\hline
bathrooms\\_median & Número de baños de la vivienda \\\\
\\hline
surface\\_total\\_median & Área total de la vivienda  \\\\
\\hline
property\\_type & =1 si la vivienda corresponde a una casa \\\\
distancia\\_avenida_\\principal & Dato 5 \\\\
\\hline
distancia\\_parque & Distancia de la vivienda al parque más cercano \\\\
\\hline
distancia\\_comercial & Distancia de la vivienda al cento comercial más cercano \\\\
\\hline
distancia\\_avenida\\_principal & Distancia de la vivienda a la avenida principal\\\\
\\hline
distancia\\_universidad & Distancia de la vivienda a la universidad más cercana \\\\
\\hline
distancia\\_cai & Distancia de la vivienda al CAI de policía más cercano \\\\
\\hline
distancia\\_bar & Distancia de la vivienda al bar más cercano \\\\
\\hline
distancia\\_gimnasio & Distancia de la vivienda al gimnasio más cercano \\\\
\\hline
distancia\\_transmi & Distancia de la vivienda a la estación de transmilenio más cercana \\\\
\\hline
distancia\\_SM & Distancia de la vivienda al Supermercado más cercano \\\\
\\hline
distancia\\_colegio & Distancia de la vivienda al colegio más cercano \\\\
\\hline
distancia\\_hospitales & Distancia de la vivienda al hospital más cercano \\\\
\\hline
month,year & Año-mes  \\\\
\\hline
lat,lon & Coordenadas de geolocalización de la casa \\\\
\\hline
\\end{tabular}
\\end{table}
")
```

             
## Descripción del modelo


## Comparativa con otros modelos
Además del modelo finalmente escogido, se ejecutaron otras técnicas para realizar la predicción de los precios de la vivienda en Chapinero. Se utilizaron para todos los otros modelos las mismas variables explicativas descritas en la tabla anexo. Se estimaron las siguientes técnicas adicionales al random forest: regresión lineal, Elastic net, Boosting y árboles de decisión. Para todos estos modelos, se utiliza un cross-validation con 10 particiones con el fin de 

```{r performance2, results='asis', echo=FALSE}
cat("
\\begin{table}[ht]
\\centering
\\caption{Comparativa con otros modelos}
\\begin{tabular}{lcccccr}
\\hline \\hline
Estadística & Random Forest & RL & Linear Regression & Elastic Net & Boosting & Decision tree \\\\
\\hline
MAE (Kaggle) & 223834975 & 308749889 & 260870545 & 289260591 & 304528484 & 279848874 \\\\
RMSE & 185392301 & 258160495 & 210281690 & 266505969 & 282794569 & 240176517 \\\\
MAE(train) & 125757655 & 191380688 & 143548002 & 200055282 & 216060881 & 178784207 \\\\
\\hline
\\end{tabular}
\\end{table}
")
```



# Conclusiones
El presente estudio realizó un 

# Referencias bibliográficas




::: {#refs}
:::

# Repositorio

El respositorio se puede consultar en el siguiente enlace:
\begin{itemize}
  \item \href{https://github.com/guscastilloa/PS3_Repo-G3}{Problem Set 3: Making Money with ML?}
\end{itemize}
